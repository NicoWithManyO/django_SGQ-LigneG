{% extends 'management/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'management/css/reports.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid" x-data="formationsPage()" x-init="init()">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">{{ title }}</h1>
            <p class="text-muted">Récapitulatif des formations des 6 derniers mois</p>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="row mb-4" x-show="statistics">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Opérateurs formés</h5>
                    <h2 class="text-primary" x-text="statistics?.total_trainees || 0"></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Sessions totales</h5>
                    <h2 class="text-info" x-text="statistics?.total_sessions || 0"></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Période</h5>
                    <div class="small">
                        <div x-text="formatDate(statistics?.period_start)"></div>
                        <div x-text="formatDate(statistics?.period_end)"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Moyenne par formé</h5>
                    <h2 class="text-warning" x-text="Math.round((statistics?.total_sessions || 0) / (statistics?.total_trainees || 1)) + ' sessions'"></h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des formations par opérateur -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Formations par opérateur</h5>
                </div>
                <div class="card-body">
                    <div x-show="loading" class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    
                    <div x-show="!loading && formations.length === 0" class="text-center py-4 text-muted">
                        <i class="bi bi-people-fill display-4 mb-3"></i>
                        <p>Aucune formation trouvée sur les 6 derniers mois.</p>
                    </div>

                    <div x-show="!loading && formations.length > 0">
                        <template x-for="(traineeData, index) in formations" :key="traineeData.trainee.id">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <h6 class="mb-0">
                                                <i class="bi bi-person-fill me-2"></i>
                                                <span x-text="traineeData.trainee.full_name"></span>
                                                <small class="text-muted" x-text="'(' + traineeData.trainee.employee_id + ')'"></small>
                                            </h6>
                                        </div>
                                        <div class="col-auto">
                                            <span class="badge bg-primary" x-text="traineeData.total_sessions + ' sessions'"></span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col">
                                            <small class="text-muted">
                                                <strong>Formateurs :</strong> <span x-text="traineeData.formateurs.join(', ')"></span>
                                            </small>
                                        </div>
                                        <div class="col-auto">
                                            <small class="text-muted">
                                                <strong>Période :</strong> 
                                                <span x-text="formatDate(traineeData.first_formation)"></span> → 
                                                <span x-text="formatDate(traineeData.last_formation)"></span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Onglets pour chaque opérateur formé -->
                                    <ul class="nav nav-tabs" role="tablist" :id="'tabs-trainee-' + traineeData.trainee.id">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" 
                                                    :id="'tab-stats-' + traineeData.trainee.id" 
                                                    data-bs-toggle="tab" 
                                                    :data-bs-target="'#stats-' + traineeData.trainee.id" 
                                                    type="button" role="tab">
                                                <i class="bi bi-graph-up me-1"></i>Moyennes
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" 
                                                    :id="'tab-sessions-' + traineeData.trainee.id" 
                                                    data-bs-toggle="tab" 
                                                    :data-bs-target="'#sessions-' + traineeData.trainee.id" 
                                                    type="button" role="tab">
                                                <i class="bi bi-list-ul me-1"></i>Sessions
                                                <span class="badge bg-primary ms-1" x-text="traineeData.total_sessions"></span>
                                            </button>
                                        </li>
                                    </ul>

                                    <div class="tab-content mt-3">
                                        <!-- Onglet Statistiques -->
                                        <div class="tab-pane fade show active" 
                                             :id="'stats-' + traineeData.trainee.id" 
                                             role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="card text-center bg-light">
                                                        <div class="card-body py-3">
                                                            <h6 class="card-title">TRS Moyen</h6>
                                                            <h4 class="text-primary mb-0" 
                                                                x-text="traineeData.statistics?.avg_trs ? traineeData.statistics.avg_trs + '%' : 'N/A'">
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="card text-center bg-light">
                                                        <div class="card-body py-3">
                                                            <h6 class="card-title">Défauts par poste</h6>
                                                            <h4 class="text-warning mb-0" 
                                                                x-text="traineeData.statistics?.avg_defects_per_shift || '0'">
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="card text-center bg-light">
                                                        <div class="card-body py-3">
                                                            <h6 class="card-title">Production moy.</h6>
                                                            <h4 class="text-info mb-0" 
                                                                x-text="traineeData.statistics?.avg_production_per_shift ? Math.round(traineeData.statistics.avg_production_per_shift) + ' m' : 'N/A'">
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="card text-center bg-light">
                                                        <div class="card-body py-3">
                                                            <h6 class="card-title">Qualité moy.</h6>
                                                            <h4 class="text-success mb-0" 
                                                                x-text="traineeData.statistics?.avg_quality_rate ? traineeData.statistics.avg_quality_rate + '%' : 'N/A'">
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Statistiques détaillées -->
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <h6>Totaux cumulés</h6>
                                                    <ul class="list-group list-group-flush">
                                                        <li class="list-group-item d-flex justify-content-between">
                                                            <span>Production totale</span>
                                                            <strong x-text="Math.round(traineeData.statistics?.total_production || 0) + ' m'"></strong>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between">
                                                            <span>Rouleaux produits</span>
                                                            <strong x-text="traineeData.statistics?.total_rolls || 0"></strong>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between">
                                                            <span>Défauts totaux</span>
                                                            <strong x-text="traineeData.statistics?.total_defects || 0"></strong>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Moyennes par poste</h6>
                                                    <ul class="list-group list-group-flush">
                                                        <li class="list-group-item d-flex justify-content-between">
                                                            <span>Rouleaux par poste</span>
                                                            <strong x-text="traineeData.statistics?.avg_rolls_per_shift || 0"></strong>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between">
                                                            <span>Sessions de formation</span>
                                                            <strong x-text="traineeData.total_sessions"></strong>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between">
                                                            <span>Formateurs différents</span>
                                                            <strong x-text="traineeData.formateurs.length"></strong>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Onglet Sessions -->
                                        <div class="tab-pane fade" 
                                             :id="'sessions-' + traineeData.trainee.id" 
                                             role="tabpanel">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Vacation</th>
                                                            <th>Formateur</th>
                                                            <th>TRS</th>
                                                            <th>Défauts</th>
                                                            <th>Production</th>
                                                            <th>ID Poste</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <template x-for="formation in traineeData.formations" :key="formation.id">
                                                            <tr>
                                                                <td x-text="formatDate(formation.date)"></td>
                                                                <td>
                                                                    <span class="badge bg-secondary" x-text="formation.vacation"></span>
                                                                </td>
                                                                <td x-text="formation.formateur.full_name"></td>
                                                                <td>
                                                                    <span x-show="formation.trs" 
                                                                          class="badge"
                                                                          :class="getTRSClass(formation.trs)"
                                                                          x-text="formation.trs + '%'">
                                                                    </span>
                                                                    <span x-show="!formation.trs" class="text-muted">N/A</span>
                                                                </td>
                                                                <td>
                                                                    <span x-text="formation.defects_count" 
                                                                          :class="formation.defects_count > 0 ? 'text-warning' : 'text-success'">
                                                                    </span>
                                                                </td>
                                                                <td x-text="Math.round(formation.total_length) + ' m'"></td>
                                                                <td>
                                                                    <button type="button" 
                                                                            class="btn btn-link text-decoration-none fw-bold p-0"
                                                                            @click.prevent="showShiftDetails(formation.id)"
                                                                            x-text="formation.shift_id"></button>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale détails poste -->
<div class="modal fade" id="shiftDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clipboard-data me-2"></i>
                    Détails du poste <span x-text="shiftDetails?.shift_id" class="fw-bold"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Spinner de chargement -->
                <div x-show="isLoadingShiftDetails" class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <div class="mt-3">Chargement des détails...</div>
                </div>
                
                <!-- Contenu de la modale -->
                <div x-show="!isLoadingShiftDetails && shiftDetails">
                    <!-- KPIs principaux -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card border text-center">
                                <div class="card-body p-2">
                                    <h6 class="mb-1 text-muted">TRS</h6>
                                    <h3 class="mb-0 sg-gradient-text fw-bold" x-text="shiftDetails?.kpis?.trs ? shiftDetails.kpis.trs + '%' : '--'">--</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border text-center">
                                <div class="card-body p-2">
                                    <h6 class="mb-1 text-muted">Disponibilité</h6>
                                    <h3 class="mb-0 sg-gradient-text fw-bold" x-text="shiftDetails?.kpis?.availability ? shiftDetails.kpis.availability + '%' : '--'">--</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border text-center">
                                <div class="card-body p-2">
                                    <h6 class="mb-1 text-muted">Performance</h6>
                                    <h3 class="mb-0 sg-gradient-text fw-bold" x-text="shiftDetails?.kpis?.performance ? shiftDetails.kpis.performance + '%' : '--'">--</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border text-center">
                                <div class="card-body p-2">
                                    <h6 class="mb-1 text-muted">Qualité</h6>
                                    <h3 class="mb-0 sg-gradient-text fw-bold" x-text="shiftDetails?.kpis?.quality ? shiftDetails.kpis.quality + '%' : '--'">--</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informations générales et production -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Informations générales</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td class="text-muted">Date :</td>
                                    <td x-text="shiftDetails?.date ? new Date(shiftDetails.date).toLocaleDateString('fr-FR') : '--'"></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Vacation :</td>
                                    <td><span class="badge bg-secondary" x-text="shiftDetails?.vacation"></span></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Opérateur :</td>
                                    <td x-text="shiftDetails?.operator"></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Horaires :</td>
                                    <td>
                                        <span x-text="shiftDetails?.start_time || '--'"></span> → 
                                        <span x-text="shiftDetails?.end_time || '--'"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">État machine :</td>
                                    <td>
                                        <span :class="shiftDetails?.started_at_beginning ? 'text-success' : 'text-danger'">
                                            <i :class="shiftDetails?.started_at_beginning ? 'bi-play-circle-fill' : 'bi-stop-circle-fill'"></i>
                                            Début
                                        </span>
                                        <span class="mx-2">→</span>
                                        <span :class="shiftDetails?.started_at_end ? 'text-success' : 'text-danger'">
                                            <i :class="shiftDetails?.started_at_end ? 'bi-play-circle-fill' : 'bi-stop-circle-fill'"></i>
                                            Fin
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Production</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td class="text-muted">Longueur totale :</td>
                                    <td><span x-text="shiftDetails?.total_length || '0'"></span> m</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Longueur OK :</td>
                                    <td class="text-success"><span x-text="shiftDetails?.ok_length || '0'"></span> m</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Longueur NOK :</td>
                                    <td class="text-danger"><span x-text="shiftDetails?.nok_length || '0'"></span> m</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Déchet :</td>
                                    <td class="text-warning"><span x-text="shiftDetails?.waste_length || '0'"></span> m</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Nombre de rouleaux :</td>
                                    <td><span x-text="shiftDetails?.rolls_count || '0'"></span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Formation info si applicable -->
                    <div class="mb-4" x-show="shiftDetails?.is_training_shift">
                        <h6 class="text-muted mb-3">Formation</h6>
                        <div class="alert alert-info">
                            <i class="bi bi-mortarboard me-2"></i>
                            Ce poste était un <strong>poste de formation</strong>
                            <div x-show="shiftDetails?.trainee" class="mt-2">
                                <strong>Personne formée :</strong> <span x-text="shiftDetails?.trainee"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Commentaires -->
                    <div class="mb-4" x-show="shiftDetails?.operator_comments">
                        <h6 class="text-muted mb-2">Commentaires</h6>
                        <div class="mb-2">
                            <strong>Opérateur :</strong>
                            <p class="border rounded p-2 bg-light mb-2" x-text="shiftDetails.operator_comments"></p>
                        </div>
                    </div>
                    
                    <!-- Rouleaux produits -->
                    <div class="mb-4" x-show="shiftDetails?.rolls && shiftDetails.rolls.length > 0">
                        <h6 class="text-muted mb-3">Rouleaux produits</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID Rouleau</th>
                                        <th>Longueur</th>
                                        <th>Grammage</th>
                                        <th>Moy. EP G</th>
                                        <th>Moy. EP D</th>
                                        <th>Défauts</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="roll in shiftDetails.rolls" :key="roll.id">
                                        <tr>
                                            <td x-text="roll.roll_id" class="small"></td>
                                            <td x-text="roll.length ? roll.length + ' m' : '--'" class="small"></td>
                                            <td x-text="roll.grammage ? roll.grammage + ' g/m²' : '--'" class="small"></td>
                                            <td x-text="roll.avg_thickness_left ? roll.avg_thickness_left.toFixed(2) : '--'" class="small"></td>
                                            <td x-text="roll.avg_thickness_right ? roll.avg_thickness_right.toFixed(2) : '--'" class="small"></td>
                                            <td class="text-center">
                                                <span x-show="roll.defects_count > 0" 
                                                      class="badge bg-warning text-dark"
                                                      x-text="roll.defects_count"></span>
                                                <span x-show="roll.defects_count === 0" class="text-muted">-</span>
                                            </td>
                                            <td>
                                                <span class="badge" 
                                                      :class="roll.is_conform ? 'bg-success' : 'bg-danger'"
                                                      x-text="roll.is_conform ? 'OK' : 'NOK'"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Temps perdus -->
                    <div class="mb-4" x-show="shiftDetails?.lost_times && shiftDetails.lost_times.length > 0">
                        <h6 class="text-muted mb-3">
                            Temps perdus
                            <small class="ms-2">Total : <span x-text="shiftDetails?.total_lost_time || '0'"></span> minutes</small>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Raison</th>
                                        <th>Catégorie</th>
                                        <th>Durée</th>
                                        <th>Commentaire</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="entry in shiftDetails.lost_times" :key="entry">
                                        <tr>
                                            <td x-text="entry.reason" class="small"></td>
                                            <td x-text="entry.category" class="small"></td>
                                            <td x-text="entry.duration + ' min'" class="small"></td>
                                            <td x-text="entry.comment || '-'" class="small"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
function formationsPage() {
    return {
        formations: [],
        statistics: null,
        loading: true,
        shiftDetails: null,
        isLoadingShiftDetails: false,
        
        async init() {
            await this.loadFormations();
        },
        
        async loadFormations() {
            this.loading = true;
            try {
                const response = await fetch('/management/api/formations-recap/');
                const data = await response.json();
                
                if (response.ok) {
                    this.formations = data.formations;
                    this.statistics = data.statistics;
                } else {
                    console.error('Erreur API:', data.error);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des formations:', error);
            } finally {
                this.loading = false;
            }
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR');
        },
        
        async showShiftDetails(shiftId) {
            console.log('=== DEBUT showShiftDetails ===', shiftId);
            this.isLoadingShiftDetails = true;
            this.shiftDetails = null;
            
            // Ouvrir la modale immédiatement avec le spinner
            const modalElement = document.getElementById('shiftDetailsModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            try {
                console.log('Sending fetch request...');
                // Charger les détails du poste
                const response = await fetch(`/management/api/shifts/${shiftId}/`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    credentials: 'same-origin'
                });
                console.log('Response received:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    console.error('Erreur API:', response.status, errorData);
                    throw new Error(`Erreur ${response.status}: ${errorData.detail || errorData.error || response.statusText}`);
                }
                
                console.log('Parsing JSON...');
                const shiftDetails = await response.json();
                console.log('Shift details received:', shiftDetails);
                
                // Stocker les détails dans le contexte
                this.shiftDetails = shiftDetails;
                console.log('Shift details stored in context');
                
            } catch (error) {
                console.error('Erreur détails poste:', error);
                // Fermer la modale en cas d'erreur
                modal.hide();
                alert('Impossible de charger les détails du poste');
            } finally {
                console.log('=== FINALLY: stopping loading ===');
                this.isLoadingShiftDetails = false;
            }
        },
        
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        },
        
        getTRSClass(trs) {
            if (!trs) return 'bg-secondary';
            if (trs >= 85) return 'bg-success';
            if (trs >= 70) return 'bg-warning';
            return 'bg-danger';
        }
    };
}
</script>
{% endblock %}